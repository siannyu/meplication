<!DOCTYPE html>
<html>

<head>
    <!-- jQuery cdn -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- jQuery ui cdn -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"
        integrity="sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css"
        integrity="sha512-aOG0c6nPNzGk+5zjwyJaoRUgCdOrfSDhmMID2u4+OIslr0GjpLKo7Xm0Ao3xmpM4T8AmIouRkqwj1nrdVsLKEQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- bootstrap cdn -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>
    <!-- momentjs cdn -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
        integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <header></header>
    <main>
        기간제 아이템들을 등록하고 한번에 관리할 수 있는 페이지 입니다.
        <hr>
        <div class="container">
            <div class="row">
                <div class="ui-widget col-xs-12">
                    <label for="itemName">아이템 이름 : </label>
                    <input type="text" id="itemName">
                </div>
                <div class="col-xs-4">
                    <label for="datepicker">날짜 선택 : </label>
                    <input type="text" id="datepicker">
                </div>
                <div class="col-xs-4">
                    <label for="time">시간 입력 : </label>
                    <input type="text" id="time" placeholder="ex) 1330">
                </div>
            </div>
            <div class="text-center">
                <button id="btn_add">+</button>
            </div>
        </div>
        <hr>
        <div class="container">
            <div class="row" id="itemList">
            </div>
        </div>
    </main>

    <script>
        $(function () {
            // datepicker
            $("#datepicker").datepicker({
                changeMonth: true,
                dateFormat: 'yy-mm-dd',
                monthNames: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
                monthNamesShort: ['1,', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
                dayNames: ['월요일', '화요일', '수요일', '목요일', '금요일', '토요일', '일요일'],
                dayNamesMin: ['월', '화', '수', '목', '금', '토', '일']
            });

            // autocomplete
            $("#itemName").autocomplete({
                source: function (request, response) {
                    $.ajax({
                        type: "get",
                        url: "/meplication/json/ItemList.json",
                        dataType: "json",
                        success: function (data) {
                            response(
                                $.map(data, function (item) {
                                    if (item.indexOf(request.term) >= 0) {
                                        return {
                                            label: item,
                                            value: item
                                        };
                                    }
                                })
                            );
                        }
                    });
                },
                minLength: 1,
                focus: function (event, ui) {
                    return false;
                }
            });

            // localStorge값 불러오기
            if (localStorage.getItem('item') != null) {
                let parsedList = JSON.parse(localStorage.getItem('item'));
                for (let i = 0; i < parsedList.length; i++) {
                    let itemName = parsedList[i]['itemName'],
                        dday = parsedList[i]['dday'];

                    let itemSource = `
                    <div data-idx="${i}">
                        <div>
                            ${itemName}
                        </div>
                        <div>
                            만료기간 :
                            <span class="availableDate">
                                ${transfromDate(dday)}
                            </span>
                        </div>
                        <div>
                            남은시간 : 
                            <span class="remaindDate">
                            </span>
                        </div>
                        <button type="button" class="btn_delete">X</button>
                    </div>
                    `
                    $('#itemList').append(itemSource);

                }
            } else {
                localStorage.setItem('item', '[]');
                localStorage.setItem('lastIdx', '0');
            }

            // 남은시간계산 함수 주기생성
            setInterval(liveUpdate, 1000);
        });

        // 입력 숫자 시간 자동 변경
        $("#time").change(function () {
            let dateTime = parseInt($("#time").val());
            let hour = parseInt(dateTime / 100),
                min = parseInt(dateTime % 100);

            if (hour < 10) hour = String(hour).padStart(2, '0');
            if (min < 10) min = String(min).padStart(2, '0');

            if (parseInt(min) < 60) {
                if (parseInt(hour) < 12) {
                    $('#time').val(hour + ' : ' + min + ' AM');
                } else if (parseInt(hour) >= 24) {
                    alert('올바르지 않는 값입니다.');
                    $('#time').val('');
                } else if (parseInt(hour) == 12) {
                    $('#time').val(hour + ' : ' + min + ' PM');
                } else {
                    hour %= 12;
                    hour = String(hour).padStart(2, '0');
                    $('#time').val(hour + ' : ' + min + ' PM');
                }
            } else {
                alert('올바르지 않는 값입니다.');
                $('#time').val('');
            }
        });

        // 남은시간 계산
        function remaindTime(end) {
            let now = new Date();

            let remaindMSec = end.getTime() - now.getTime();

            let remaind = Math.floor(remaindMSec / 1000);
            let remaindSec = Math.floor(remaind % 60),
                remaindMin = Math.floor(remaind / 60 % 60),
                remaindHour = Math.floor(remaind / 60 / 60 % 24),
                remaindDay = Math.floor(remaind / 60 / 60 / 24);

            return (remaindDay + '일 ' + remaindHour + '시간 ' + remaindMin + '분' + remaindSec + '초');
        }

        // 날짜, 시간 분리
        function splitDate(obj) {
            return {
                year: obj.substr(0, 4),
                month: obj.substr(4, 2),
                day: obj.substr(6, 2),
                hour: obj.substr(8, 2),
                min: obj.substr(10, 2)
            }
        }

        // 남은시간 실시간 업데이트
        function liveUpdate() {
            if (localStorage.getItem('lastIdx') == 0) return false;

            for (let i = 0; i < $('.availableDate').length; i++) {
                let objDate = splitDate(JSON.parse(localStorage.getItem('item'))[i]['dday']);
                let availableDate = new Date(objDate['year'], objDate['month'] - 1, objDate['day'], objDate['hour'], objDate['min']);

                $('.remaindDate').eq(i).text(remaindTime(availableDate));
            }
        }

        // 출력 형태 변경
        function transfromDate(str) {
            let obj = splitDate(str)

            return obj.year + '년 ' + obj.month + '월 ' + obj.day + '일 ' + obj.hour + '시 ' + obj.min + '분';
        }

        // 아이템 추가 버튼
        $('#btn_add').click(function () {
            let lastIdx = localStorage.getItem('lastIdx'),
                abbDate = ($('#datepicker').val() + ' ' + $('#time').val()).replace(/[^0-9]/g, '');
            let itemSource = `
                <div date-idx="${lastIdx++}">
                    <div>
                        ${$('#itemName').val()}
                    </div>
                    <div>
                        만료기간 :
                        <span class="availableDate">
                            ${transfromDate(abbDate)}
                        </span>
                    </div>
                    <div>
                        남은시간 : 
                        <span class="remaindDate">
                        </span>
                    </div>
                    <button type="button" class="btn_delete">X</button>
                </div>
                `

            // 빈칸체크
            if ($('#itemName').val().length == 0) {
                alert('아이템 이름을 입력해 주세요.');
                $('#itemName').focus();

                return false;
            }
            if ($('#datepicker').val().length == 0) {
                alert('날짜를 선택해 주세요.');
                $('#datepicker').focus();

                return false;
            }
            if ($('#time').val().length == 0) {
                alert('시간을 입력해 주세요.');
                $('#time').focus();

                return false;
            }

            $('#itemList').append(itemSource);

            // lastIdx 업데이트
            localStorage.setItem('lastIdx', lastIdx);

            // localStorage 업데이트
            let setJSON = {
                itemName: $('#itemName').val(),
                dday: abbDate
            }
            let getJSON = JSON.parse(localStorage.getItem('item'));

            getJSON.push(setJSON);
            localStorage.setItem('item', JSON.stringify(getJSON));

            // 초기화
            $('#itemName').val('');
            $('#datepicker').val('');
            $('#time').val('');
        });

        // 아이템 리스트 목록 삭제
        $(document).on('click', '.btn_delete', function () {
            let idx = $($(this).parents()[0]).data("idx");
            let getJSON = JSON.parse(localStorage.getItem('item')),
                lastIdx = localStorage.getItem('lastIdx');

            getJSON.splice(idx, 1);
            localStorage.setItem('item', JSON.stringify(getJSON));
            localStorage.setItem('lastIdx', --lastIdx);

            $(this).parents('div')[0].remove();
        });

        // includeHTML
        $('header').load('/meplication/include/header.html')
    </script>
</body>

</html>